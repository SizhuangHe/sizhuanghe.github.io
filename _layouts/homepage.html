<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <title>{{ site.title }} | {{site.affiliation}}</title>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="{{ site.description }}">
    {% if site.keywords %}
    <meta name="keywords" content="{{ site.keywords }}">
    {% endif %}
    {% if site.canonical %}
    <link rel="canonical" href="{{ site.canonical }}"/>
    {% endif %}

    <link rel="icon" media="(prefers-color-scheme:dark)" href="{{ site.favicon_dark }}" type="image/png" />
    <link rel="icon" media="(prefers-color-scheme:light)" href="{{ site.favicon }}" type="image/png" />
    <script src="./assets/js/favicon-switcher.js" type="application/javascript"></script>

    <link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    {% if site.font == "Sans Serif" %}
    <link rel="stylesheet" href="./assets/css/font_sans_serif.css">
    {% else %}
    <link rel="stylesheet" href="./assets/css/font.css">
    {% endif %}
    {% if site.auto_dark_mode %}
    <link rel="stylesheet" href="./assets/css/style.css">
    <link rel="stylesheet" href="./assets/css/publications.css">
    {% else %}
    <link rel="stylesheet" href="./assets/css/style-no-dark-mode.css">
    <link rel="stylesheet" href="./assets/css/publications-no-dark-mode.css">
    {% endif %}

  </head>
  <body>
    <div class="wrapper">
      <header>
        
        {% if site.avatar %}
        <a class="image avatar"><img id="random-avatar" src="{{ site.avatar }}" alt="avatar" /></a>
        {% endif %}

        <h1>{{ site.title }}</h1>

        {% if site.position %}
        <position style="font-size:1.10rem;">{{ site.position }}</position>
        <br>
        {% endif %}
        {% if site.affiliation %}
        <a href="{{ site.affiliation_link }}" rel="noopener"><autocolor>{{ site.affiliation }}</autocolor></a>
        <br>
        {% endif %}
        {% if site.email %}
        <email>{{ site.email }}</email>
        {% endif %}

        <br>
        <br>
        <div class="social-icons">
        {% if site.google_scholar %}
        <a style="margin: 0 5px 0 0" href="{{ site.google_scholar }}">
          <i class="ai ai-google-scholar" style="font-size:1.2rem"></i>
        </a>  
        {% endif %}

        {% if site.cv_link %}
        <a style="margin: 0 5px 0 0" href="{{ site.cv_link }}">
          <i class="ai ai-cv" style="font-size:1.3rem;"></i>
        </a>
        {% endif %}

        {% if site.github_link %}
        <a style="margin: 0 5px 0 0" href="{{ site.github_link }}">
          <i class="fab fa-github"></i>
        </a>
        {% endif %}

        {% if site.linkedin %}
        <a style="margin: 0 5px 0 0" href="{{ site.linkedin }}">
          <i class="fab fa-linkedin"></i>
        </a>
        {% endif %}

        {% if site.twitter %}
        <a style="margin: 0 0 0 0" href="{{ site.twitter }}">
          <i class="fab fa-x-twitter"></i>
        </a>
        {% endif %}
        </div>
        <br>

      </header>
      <section>

      {{ content }}

      <br>

      {% if site.enable_footnote %}
      <p><small>Powered by Jekyll and <a href="https://github.com/yaoyao-liu/minimal-light" target="_blank" rel="noopener">Minimal Light</a> theme.</small></p>
      {% endif %}

      </section>
      <footer>
        
      </footer>
    </div>
    <script src="{{ "/assets/js/scale.fix.js" | relative_url }}"></script>
    <script>
      function toggleAuthors(element) {
        const truncated = element.previousElementSibling;
        const full = element.nextElementSibling;
        
        // Show full author list
        truncated.style.display = 'none';
        element.style.display = 'none';
        full.style.display = 'inline';
        
        // Add collapse button directly to the full author span
        const collapseButton = document.createElement('span');
        collapseButton.className = 'author-collapse';
        collapseButton.style.color = '#888888';
        collapseButton.style.cursor = 'pointer';
        collapseButton.style.textDecoration = 'underline dashed';
        collapseButton.style.marginLeft = '5px';
        collapseButton.innerHTML = 'show less';
        collapseButton.onclick = function() { collapseAuthors(this); };
        
        full.appendChild(document.createTextNode(' '));
        full.appendChild(collapseButton);
      }
      
      function collapseAuthors(element) {
        const fullSpan = element.parentElement;
        const authorDiv = fullSpan.parentElement;
        const truncated = authorDiv.querySelector('.author-truncated');
        const toggle = authorDiv.querySelector('.author-toggle');
        
        // Remove the collapse button
        element.remove();
        
        // Hide full author list
        fullSpan.style.display = 'none';
        
        // Show truncated version and toggle button
        truncated.style.display = 'inline';
        toggle.style.display = 'inline';
      }
    </script>
    {% if site.google_analytics %}
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', '{{ site.google_analytics }}', 'auto');
      ga('send', 'pageview');
    </script>
    {% endif %}
    
    <style>
      /* BibTeX inline container styles */
      .bibtex-container {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      
      .bibtex-code {
        font-feature-settings: "liga" 0;
        tab-size: 2;
      }
      
      @media (prefers-color-scheme: dark) {
        .bibtex-container {
          background-color: #2d3748 !important;
          border-left-color: #4299e1 !important;
        }
        
        .bibtex-container strong {
          color: #e2e8f0 !important;
        }
        
        .bibtex-container pre {
          color: #e2e8f0 !important;
        }
        
        .bibtex-container button {
          background-color: #4a5568 !important;
          color: #e2e8f0 !important;
          border-color: #718096 !important;
        }
        
        .bibtex-container button:hover {
          background-color: #718096 !important;
        }
        
        /* Abstract container dark mode */
        .abstract-container {
          background-color: #2d3748 !important;
          border-left-color: #48bb78 !important;
        }
        
        .abstract-container div {
          color: #e2e8f0 !important;
        }
        
        .abstract-container button {
          background-color: #4a5568 !important;
          color: #e2e8f0 !important;
          border-color: #718096 !important;
        }
        
        .abstract-container button:hover {
          background-color: #718096 !important;
        }
        
        /* Dark mode syntax highlighting */
        .bibtex-container .bibtex-code span[style*="color: #6f42c1"] {
          color: #ff79c6 !important; /* Purple for @article */
        }
        
        .bibtex-container .bibtex-code span[style*="color: #e36209"] {
          color: #50fa7b !important; /* Green for field names */
        }
        
        .bibtex-container .bibtex-code span[style*="color: #032f62"] {
          color: #f1fa8c !important; /* Yellow for values */
        }
        
        .bibtex-container .bibtex-code span[style*="color: #24292e"] {
          color: #e2e8f0 !important; /* Light gray for punctuation */
        }
      }
    </style>
    
    <!-- Random Avatar Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const avatarImages = [
          './assets/img/avatars/brooklyn_bridge.png',
          './assets/img/avatars/kitty.png'
        ];
        
        const randomIndex = Math.floor(Math.random() * avatarImages.length);
        const randomAvatar = avatarImages[randomIndex];
        
        const avatarElement = document.getElementById('random-avatar');
        if (avatarElement) {
          avatarElement.src = randomAvatar;
        }
      });
      
      // BibTeX Inline Functions
      window.toggleBibtex = function(containerId, bibtexUrl) {
        const container = document.getElementById(containerId);
        const preElement = document.getElementById('bibtex-content-' + containerId.split('-')[1]);
        
        if (container.style.display === 'none' || container.style.display === '') {
          // Show the text box and load content if not already loaded
          if (preElement.textContent === '') {
            fetch(bibtexUrl)
              .then(response => response.text())
              .then(bibtexContent => {
                // Clean the BibTeX content (remove abstract)
                const cleanedBibtex = cleanBibtexContent(bibtexContent);
                // Apply syntax highlighting
                preElement.innerHTML = highlightBibtex(cleanedBibtex);
              })
              .catch(error => {
                console.error('Error loading BibTeX:', error);
                preElement.textContent = 'Error loading BibTeX content.';
              });
          }
          container.style.display = 'block';
        } else {
          // Hide the display
          container.style.display = 'none';
        }
      };
      
      window.copyBibtexContent = function(preElementId) {
        const preElement = document.getElementById(preElementId);
        const textContent = preElement.textContent || preElement.innerText;
        
        // Create a temporary textarea to copy the plain text
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textContent;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        tempTextArea.setSelectionRange(0, 99999);
        
        try {
          document.execCommand('copy');
          document.body.removeChild(tempTextArea);
          
          // Provide visual feedback by changing the icon temporarily
          const copyButton = event.target.closest('button');
          const svg = copyButton.querySelector('svg');
          const originalHTML = svg.innerHTML;
          
          // Change to checkmark icon
          svg.innerHTML = '<path d="M20 6L9 17l-5-5"></path>';
          copyButton.style.color = '#28a745';
          
          setTimeout(() => {
            svg.innerHTML = originalHTML;
            copyButton.style.color = '#495057';
          }, 2000);
        } catch (err) {
          console.error('Failed to copy: ', err);
          if (document.body.contains(tempTextArea)) {
            document.body.removeChild(tempTextArea);
          }
        }
      };
      
      // Abstract Toggle Functions
      window.toggleAbstract = function(containerId) {
        const container = document.getElementById(containerId);
        
        if (container.style.display === 'none' || container.style.display === '') {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
      };
      
      // Function to apply syntax highlighting to BibTeX
      function highlightBibtex(bibtexContent) {
        // Escape HTML first to prevent conflicts
        let highlighted = bibtexContent
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        
        // Apply syntax highlighting
        highlighted = highlighted
          // Highlight entry type and key (e.g., @article{key,)
          .replace(/(@\w+)(\{)([^,\s\}]+)(,?)/g, '<span style="color: #6f42c1;">$1</span><span style="color: #24292e;">$2</span><span style="color: #032f62;">$3</span><span style="color: #24292e;">$4</span>')
          // Highlight field names (e.g., title =, author =)
          .replace(/^(\s+)(\w+)(\s*=\s*)/gm, '$1<span style="color: #e36209;">$2</span><span style="color: #24292e;">$3</span>')
          // Highlight field values in braces - handle nested braces properly
          .replace(/(\{)([^{}]*(?:\{[^{}]*\}[^{}]*)*)(\})/g, function(match, openBrace, content, closeBrace) {
            return '<span style="color: #24292e;">' + openBrace + '</span><span style="color: #032f62;">' + content + '</span><span style="color: #24292e;">' + closeBrace + '</span>';
          })
          // Highlight closing brace of entry
          .replace(/^(\s*)(\})(\s*)$/gm, '$1<span style="color: #24292e;">$2</span>$3');
          
        return highlighted;
      }
      
      // Function to clean BibTeX content by removing abstract field
      function cleanBibtexContent(bibtexContent) {
        // Remove abstract field and its content
        // This regex matches the abstract field including multi-line content
        const abstractRegex = /,?\s*abstract\s*=\s*\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/gi;
        let cleaned = bibtexContent.replace(abstractRegex, '');
        
        // Clean up any double commas that might result from removing abstract
        cleaned = cleaned.replace(/,\s*,/g, ',');
        
        // Clean up comma before closing brace
        cleaned = cleaned.replace(/,(\s*\})/g, '$1');
        
        return cleaned.trim();
      }
    </script>
  </body>
</html>
